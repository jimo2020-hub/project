#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include <assert.h>
#include <time.h>
#include "sense4.h"
#include "crypt2.h"
#include "common.h"
#include "sample_27.h"

void rsa_change(R_RSA_PUBLIC_KEY* pkey)
{

	const unsigned char pubkey_data[256] = {
	0xD4, 0x0A, 0x63, 0x25, 0x76, 0x21, 0x17, 0x7A, 0xA6, 0x6E, 0xC8, 0xDF, 0x37, 0x79, 0xA0, 0x00,
	0xE8, 0x51, 0x9B, 0xF9, 0x35, 0x56, 0x78, 0x9F, 0x0C, 0x95, 0x6B, 0x4E, 0x0E, 0xEF, 0x7D, 0xD9,
	0xB3, 0xDF, 0xA4, 0x3D, 0xCD, 0xF0, 0xBC, 0xBB, 0x46, 0xD9, 0x7D, 0x8B, 0x41, 0xD4, 0x43, 0x17,
	0xB2, 0xD7, 0x20, 0xEC, 0x1B, 0x37, 0xEB, 0xEA, 0xFD, 0xA3, 0xAA, 0xF6, 0xC6, 0xBF, 0xB9, 0xAD,
	0xE4, 0xF7, 0xC0, 0x4C, 0x45, 0xB7, 0xF8, 0xDE, 0x0D, 0x99, 0xB4, 0x1D, 0x0E, 0xDB, 0x79, 0x76,
	0x2C, 0xA4, 0x20, 0x0B, 0xD3, 0xDE, 0x86, 0xDA, 0xAD, 0x77, 0xE5, 0x02, 0x55, 0xEE, 0x48, 0x08,
	0x87, 0x05, 0x52, 0xF4, 0x9B, 0xEA, 0xFC, 0x56, 0x8B, 0xD1, 0x58, 0x9A, 0x3F, 0x98, 0xC3, 0xCF,
	0xF8, 0x8D, 0x88, 0x24, 0xA4, 0x56, 0xD8, 0xDE, 0xE6, 0x16, 0xCC, 0x71, 0x64, 0xF1, 0xAA, 0x4B,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01
	};
	pkey->bits = 1024;
	memcpy(&(pkey->modulus), pubkey_data, sizeof(pubkey_data));
	return;
}
int main(int argc, char* argv[])
{
	
	SENSE4_CONTEXT ctx = { 0 };
	SENSE4_CONTEXT* pctx = NULL;
	R_RSA_PUBLIC_KEY pub_key = {0};
	srand(time(NULL));
	unsigned long length = rand() % (129 - 16) + 16;	
	unsigned long size = 0;
	unsigned long ret = 0;
	unsigned char fid[] = "0002";
	unsigned char user_pin[] = "12345678";
	unsigned char output[256] = { 0 };
	unsigned long len = sizeof(output);
	int i = 0;
	unsigned char *lpToBeSigned = (unsigned char *)malloc(length + 1);
	rsa_change(&pub_key);
	if (lpToBeSigned == NULL)
	{
		perror("malloc error:\n");
	}
	for (i = 0; i < length; i++)
	{
		*(lpToBeSigned + i) = (unsigned char)(rand() % 0xFF);
	}
	printf("lpToBeSigned is:\n");
	for (i = 0; i < length; i++)
	{
		printf("%02X", *(lpToBeSigned + i));
	}
	printf("\n");
	
	/*列举精锐 4S 设备*/
	S4Enum(pctx, &size);
	if (size == 0)
	{
		printf("Elite4S not found!\n");
		return -1;
	}
	pctx = (SENSE4_CONTEXT*)malloc(size);
	if (pctx == NULL)
	{
		printf("Not enough memory!\n");
		return -1;
	}
	ret = S4Enum(pctx, &size);
	if (ret != S4_SUCCESS)
	{
		printf("Enumerate Elite4S error!\n");
		free(pctx);
		return -1;
	}
	memcpy(&ctx, pctx, sizeof(SENSE4_CONTEXT));
	free(pctx);
	pctx = NULL;
	/*打开精锐 4S 设备*/
	ret = S4Open(&ctx);
	if (ret != S4_SUCCESS)
	{
		printf("Open Elite4S failed!\n");
		return -1;
	}
	/*切换到根目录*/
	ret = S4ChangeDir(&ctx, "\\");
	if (ret != S4_SUCCESS)
	{
		printf("No root directory found!\n");
		S4Close(&ctx);
		return -1;
	}
	/*验证根目录下的用户 PIN 码*/
	ret = S4VerifyPin(&ctx, user_pin, 8, S4_USER_PIN);
	if (ret != S4_SUCCESS)
	{
		printf("Verify user PIN failed!\n");
		S4Close(&ctx);
		return -1;
	}
	/*执行可执行文件 0001*/
	ret = S4Execute(&ctx, (LPCSTR)fid, lpToBeSigned, length,output, len, &size);
	if (ret != S4_SUCCESS)
	{
		printf("Execute Elite4S exe failed!\n");
		S4Close(&ctx);
		return -1;
	}
	else
	{
		printf("output size is:%d,output content is:\n", size);
		for (i = 0; i < size; i++)
		{
			printf("%02x", output[i]);
		}
		printf("\n");
	}
	
	ret = Verify(DA_SHS, lpToBeSigned, length, output, size, &pub_key);
	if (ret == RE_SUCCESS)
	{
		printf("Verify success!\n");
	}
	else
	{
		printf("Verify error!\n");
		printf("error_code:0x%X\n", ret);
	}
	if (lpToBeSigned)
	{
		free(lpToBeSigned);
		lpToBeSigned = NULL;
	}
	return 0;
}





















